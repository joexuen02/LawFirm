<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Important Date Tracker</title>

    <style>
        p, body, td, input, select, button { font-family: -apple-system,system-ui,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; font-size: 14px; }
        body { padding: 0px; margin: 0px; background-color: #ffffff; }
        a { color: #1155a3; }
        .space { margin: 10px 0px 10px 0px; }
        .header { background: #003267; background: linear-gradient(to right, #011329 0%,#00639e 44%,#011329 100%); padding:20px 10px; color: white; box-shadow: 0px 0px 10px 5px rgba(0,0,0,0.75); }
        .header a { color: white; }
        .header h1 a { text-decoration: none; }
        .header h1 { padding: 0px; margin: 0px; }
        .main { padding: 10px; margin-top: 10px; }
    </style>

    <!-- DayPilot library -->
    <script src="js/daypilot/daypilot-all.min.js"></script>

    <link type="text/css" rel="stylesheet" href="icons/style.css" />
    <link type="text/css" rel="stylesheet" href="index.css" />

</head>
<body>
<div class="main" style="display:flex;">
    <div style="margin-right: 10px;">
        <div id="nav"></div>
    </div>

    <div style="flex-grow: 1;">

        <div class="toolbar">

            Appointee filter:
            <select id="filter">
                <option value="0">All</option>
                <option value="1">Lawyer</option>
                <option value="2">Paralegal</option>
                <option value="4">Client</option>
            </select>

            <button id="addroom">Add Task</button>

            <div class="toolbar-separator"></div>

            Time range:
            <select id="timerange">
                <option value="week">Week</option>
                <option value="month" selected>Month</option>
            </select>
            <div class="toolbar-separator"></div>
            <label for="autocellwidth"><input type="checkbox" id="autocellwidth" checked>Auto Cell Width</label>

        </div>

        <div id="dp"></div>
    </div>
</div>

<script>

    const app = {
        days: DayPilot.Date.today().daysInMonth(),
        elements: {
            filter: document.querySelector("#filter"),
            timerange: document.querySelector("#timerange"),
            autocellwidth: document.querySelector("#autocellwidth"),
            addroom: document.querySelector("#addroom"),
        },
        loadTimeline(date) {
            const timeline = [];
            const start = date.getDatePart().addHours(12);

            for (let i = 0; i < app.days; i++) {
                timeline.push({start: start.addDays(i), end: start.addDays(i+1)});
            }
            return timeline;
        },
        loadReservations() {
            dp.events.load("backend_reservations.php");
        },
        async loadRooms() {
            const {data} = await DayPilot.Http.post("backend_rooms.php", { capacity: app.elements.filter.value });
            dp.update({resources: data});
        },
        addEventHandlers() {
            app.elements.filter.addEventListener("change", (e) => {
                app.loadRooms();
            });

            app.elements.timerange.addEventListener("change", () => {
                switch (app.elements.timerange.value) {
                    case "week":
                        app.days = 7;
                        nav.selectMode = "Week";
                        nav.select(nav.selectionDay);
                        break;
                    case "month":
                        app.days = dp.startDate.daysInMonth();
                        nav.selectMode = "Month";
                        nav.select(nav.selectionDay);
                        break;
                }
            });
            app.elements.autocellwidth.addEventListener("click", () => {
                dp.cellWidth = 60;  // reset for "Fixed" mode
                dp.cellWidthSpec = app.elements.autocellwidth.checked ? "Auto" : "Fixed";
                dp.update();
            });
            app.elements.addroom.addEventListener("click", async (ev) => {
                ev.preventDefault();

                const capacities = [
                    {name: "Lawyer", id: 1},
                    {name: "Paralegal", id: 2},
                    {name: "Client", id: 4},
                ];

                const form = [
                    {name: "Case Name", id: "name"},
                    {name: "Appointee", id: "capacity", type: "select", options: capacities}
                ];

                const data = {
                    capacity: 2
                };

                const modal = await DayPilot.Modal.form(form, data);
                if (modal.canceled) {
                    return;
                }

                const room = modal.result;
                const {data: result} = await DayPilot.Http.post("backend_room_create.php", room);

                room.id = result.id;
                room.status = result.status;
                dp.resources.push(room);
                dp.update();

            });
        },
        init() {
            app.loadRooms();
            app.loadReservations();
            app.addEventHandlers();
        }
    };

    const dp = new DayPilot.Scheduler("dp", {
        allowEventOverlap: false,
        scale: "Manual",
        timeline: app.loadTimeline(DayPilot.Date.today().firstDayOfMonth()),
        eventDeleteHandling: "Update",
        timeHeaders: [
            { groupBy: "Month", format: "MMMM yyyy" },
            { groupBy: "Day", format: "d" }
        ],
        eventHeight: 80,
        cellWidth: 60,
        cellWidthMin: 60,
        cellWidthSpec: "Auto",
        rowHeaderColumns: [
            {title: "Case", display: "name", sort: "name"},
            {title: "Status", sort: "status"}
        ],
        separators: [
            { location: DayPilot.Date.now(), color: "#cc000066" }
        ],
        contextMenuResource: new DayPilot.Menu({
            items: [
                { text: "Edit...", onClick: async (args) => {
                        const capacities = [
                            {name: "Lawyer", id: 1},
                            {name: "Paralegal", id: 2},
                            {name: "Client", id: 4},
                        ];

                        const statuses = [
                            {name: "Completed", id: "Completed"},
                            {name: "In Progress", id: "In Progress"},
                            {name: "Not Started", id: "Not Started"},
                        ];

                        const form = [
                            {name: "Case Name", id: "name"},
                            {name: "Appointee", id: "capacity", type: "select", options: capacities},
                            {name: "Status", id: "status", type: "select", options: statuses}
                        ];

                        const data = args.source.data;

                        const modal = await DayPilot.Modal.form(form, data);
                        if (modal.canceled) {
                            return;
                        }

                        const room = modal.result;
                        await DayPilot.Http.post("backend_room_update.php", room);
                        dp.rows.update(room);
                    }},
                { text: "Delete", onClick: async (args) => {
                        const id = args.source.id;

                        await DayPilot.Http.post("backend_room_delete.php", {id: id});
                        dp.rows.remove(id);
                    }
                }
            ]
        }),
        onBeforeRowHeaderRender: (args) => {
            args.row.columns[0].areas = [
                {right: 3, top: 3, width: 16, height: 16, cssClass: "area-menu", action: "ContextMenu", visibility: "Hover"}
            ];

            args.row.columns[1].areas = [
                {left: "calc(50% - 10px)", top: 20, width: 20, height: 20, fontColor: "#ffffff", padding: 2, style: "border-radius: 50%;" },
                // status text
                {left: 0, top: 45, right: 0, bottom: 0, html: args.row.data.status, style: "text-align: center;"},
            ];

            const icon = args.row.columns[1].areas[0];

            switch (args.row.data.status) {
                case "Completed":
                    icon.symbol = "icons/daypilot.svg#checkmark-2";
                    icon.backColor = "#6bbf45";
                    break;
                case "In Progress":
                    icon.symbol = "icons/daypilot.svg#figure";
                    icon.backColor = "#f5c447";
                    break;
                case "Not Started":
                    icon.symbol = "icons/daypilot.svg#x-2";
                    icon.backColor = "#fa3f3f";
                    break;
            }

        },
        onEventMoved: async (args) => {
            const params = {
                id: args.e.id(),
                newStart: args.newStart,
                newEnd: args.newEnd,
                newResource: args.newResource
            };

            const {data} = await DayPilot.Http.post("backend_reservation_move.php", params);
            dp.message(data.message);

        },
        onEventResized: async (args) => {
            const params = {
                id: args.e.id(),
                newStart: args.newStart,
                newEnd: args.newEnd
            };

            const {data} = await DayPilot.Http.post("backend_reservation_resize.php", params);
            dp.message("Resized");

        },
        onEventDeleted: async (args) => {
            await DayPilot.Http.post("backend_reservation_delete.php", {id: args.e.id()});
            dp.message("Deleted.");
        },
        onTimeRangeSelected: async (args) => {

            const rooms = dp.resources.map((item) => {
                return {
                    name: item.name,
                    id: item.id
                };
            });

            const form = [
                {name: "Text", id: "text"},
                {name: "Start", id: "start", dateFormat: "MM/dd/yyyy HH:mm tt"},
                {name: "End", id: "end", dateFormat: "MM/dd/yyyy HH:mm tt"},
                {name: "Case Name", id: "resource", options: rooms},
            ];

            const data = {
                start: args.start,
                end: args.end,
                resource: args.resource
            };

            const modal = await DayPilot.Modal.form(form, data);

            dp.clearSelection();
            if (modal.canceled) {
                return;
            }
            const e = modal.result;

            const {data: result} = await DayPilot.Http.post("backend_reservation_create.php", e);

            e.id = result.id;
            e.paid = result.paid;
            e.status = result.status;
            dp.events.add(e);

        },
        onEventClick: async (args) => {
            const rooms = dp.resources.map((item) => {
                return {
                    name: item.name,
                    id: item.id
                };
            });

            const statuses = [
                {name: "New", id: "New"},
                {name: "In Review", id: "Confirmed"},
                {name: "In Progress", id: "Arrived"},
                {name: "Completed", id: "CheckedOut"}
            ];

            const paidoptions = [
                {name: "0%", id: 0},
                {name: "50%", id: 50},
                {name: "100%", id: 100},
            ]

            const form = [
                {name: "Text", id: "text"},
                {name: "Start", id: "start", dateFormat: "MM/dd/yyyy h:mm tt"},
                {name: "End", id: "end", dateFormat: "MM/dd/yyyy h:mm tt"},
                {name: "Case Name", id: "resource", options: rooms},
                {name: "Status", id: "status", type: "select", options: statuses},
                {name: "Paid", id: "paid", type: "select", options: paidoptions},
            ];

            const data = args.e.data;

            const modal = await DayPilot.Modal.form(form, data);

            dp.clearSelection();
            if (modal.canceled) {
                return;
            }
            const e = modal.result;
            await DayPilot.Http.post("backend_reservation_update.php", e);
            dp.events.update(e);
        },
        onBeforeEventRender: (args) => {
            const start = new DayPilot.Date(args.data.start);
            const end = new DayPilot.Date(args.data.end);

            const today = DayPilot.Date.today();
            const now = new DayPilot.Date();

            args.data.html = `${DayPilot.Util.escapeHtml(args.data.text)} (${start.toString("M/d/yyyy")} - ${end.toString("M/d/yyyy")})`;

            switch (args.data.status) {
                case "New":
                    const in2days = today.addDays(1);

                    if (start < in2days) {
                        args.data.barColor = "#cc0000";
                        args.data.toolTip = "In waiting list";
                    }
                    else {
                        args.data.barColor = '#e69138';
                        args.data.toolTip = "New";
                    }
                    break;
                case "Confirmed":
                    const arrivalDeadline = today.addHours(18);

                    if (start < today || (start.getDatePart() === today.getDatePart() && now > arrivalDeadline)) { // must complete before 6 pm
                        args.data.barColor = "#cc4125";  // red
                        args.data.toolTip = "By The End Of The Day";
                    }
                    else {
                        args.data.barColor = "#38761d";
                        args.data.toolTip = "Received";
                    }
                    break;
                case 'Arrived': // arrived
                    const checkoutDeadline = today.addHours(10);

                    if (end < today || (end.getDatePart() === today.getDatePart() && now > checkoutDeadline)) { // must submit before 10 am
                        args.data.barColor = "#cc4125";  // red
                        args.data.toolTip = "Late Submission";
                    }
                    else
                    {
                        args.data.barColor = "#1691f4";  // blue
                        args.data.toolTip = "Last Sprint";
                    }
                    break;
                case 'CheckedOut': // checked out
                    args.data.barColor = "gray";
                    args.data.toolTip = "Completed";
                    break;
                default:
                    args.data.toolTip = "Unexpected state";
                    break;
            }

            args.data.html = `<div>${args.data.html}<br /><span style='color:gray'>${args.data.toolTip}</span></div>`;

            const paid = args.data.paid;
            const paidColor = "#aaaaaa";

            args.data.areas = [
                { bottom: 10, right: 4, html: `<div style='color:${paidColor}; font-size: 8pt;'>Paid: ${paid}%</div>`, v: "Visible"},
                { left: 4, bottom: 8, right: 4, height: 2, html: `<div style='background-color:${paidColor}; height: 100%; width:${paid}%'></div>`, v: "Visible" }
            ];

        }
    });
    dp.init();

    const nav = new DayPilot.Navigator("nav", {
        showMonths: 3,
        skipMonths: 3,
        selectMode: "Month",
        onTimeRangeSelected: (args) => {
            dp.timeline = app.loadTimeline(args.start);
            dp.update();
            app.loadReservations();
        }
    });
    nav.init();

    app.init();

</script>


</body>
</html>
